<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.18" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <link rel="icon" href="images/mylogo.png"><title>接口耗时问题排查 | 学渣很忙的博客</title><meta name="description" content="学渣很忙的博客">
    <link rel="preload" href="/blogs/assets/style-Dmi9aAPa.css" as="style"><link rel="stylesheet" href="/blogs/assets/style-Dmi9aAPa.css">
    <link rel="modulepreload" href="/blogs/assets/app-CB8GcC1F.js"><link rel="modulepreload" href="/blogs/assets/网络连接相关问题排查.html-B1HLz74L.js">
    <link rel="prefetch" href="/blogs/assets/index.html-CbWmYwb7.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Dg3SyGf0.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-Dyvjd5yP.js" as="script"><link rel="prefetch" href="/blogs/assets/具体问题列表.html-Flh1QxzS.js" as="script"><link rel="prefetch" href="/blogs/assets/接口耗时问题排查.html-Bb99ZaHf.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-C93oWQ59.js" as="script"><link rel="prefetch" href="/blogs/assets/使用VuePress搭建博客.html-WKyq6y8L.js" as="script"><link rel="prefetch" href="/blogs/assets/使用VuePress默认主题.html-CIxF3NMO.js" as="script"><link rel="prefetch" href="/blogs/assets/将博客部署到GitHub Pages.html-DyRlrYJy.js" as="script"><link rel="prefetch" href="/blogs/assets/index.html-DXZyIO4u.js" as="script"><link rel="prefetch" href="/blogs/assets/笔记01-课程简介.html-DXn22GX6.js" as="script"><link rel="prefetch" href="/blogs/assets/笔记02-BTC-密码学原理.html-CjnkAA9q.js" as="script"><link rel="prefetch" href="/blogs/assets/笔记03-BTC-数据结构.html-CZSfPOZr.js" as="script"><link rel="prefetch" href="/blogs/assets/404.html-DH8l0inO.js" as="script"><link rel="prefetch" href="/blogs/assets/setupDevtools-7MC2TMWH-DNdUJw1E.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container no-navbar no-sidebar external-link-icon" vp-container><!--[--><!----><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><!----><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><br><h2 id="网络连接相关问题排查" tabindex="-1"><a class="header-anchor" href="#网络连接相关问题排查"><span>网络连接相关问题排查</span></a></h2><h3 id="_1-使用netstat命令" tabindex="-1"><a class="header-anchor" href="#_1-使用netstat命令"><span>1. 使用<code>netstat</code>命令</span></a></h3><h4 id="_1-1-参数解释" tabindex="-1"><a class="header-anchor" href="#_1-1-参数解释"><span>1.1 参数解释</span></a></h4><table><thead><tr><th>参数</th><th>解释</th></tr></thead><tbody><tr><td><code>-a</code></td><td>显示所有连接和监听端口</td></tr><tr><td><code>-t</code></td><td>仅显示<code>TCP</code>连接</td></tr><tr><td><code>-u</code></td><td>仅显示<code>UDP</code>连接</td></tr><tr><td><code>-n</code></td><td>以数字形式显示地址和端口号，而不是尝试解析名称</td></tr><tr><td><code>-l</code></td><td>仅显示在监听状态的套接字</td></tr><tr><td><code>-p</code></td><td>显示使用该链接的进程id（需要root权限）</td></tr><tr><td><code>-r</code></td><td>显示路由表</td></tr><tr><td><code>-i</code></td><td>显示网络接口列表及其统计信息</td></tr></tbody></table><h4 id="_1-2-结果列解释" tabindex="-1"><a class="header-anchor" href="#_1-2-结果列解释"><span>1.2 结果列解释</span></a></h4><table><thead><tr><th>列名</th><th>解释</th></tr></thead><tbody><tr><td><code>proto</code></td><td>协议类型（<code>TCP</code>/<code>UDP</code>)</td></tr><tr><td><code>Recv-Q</code></td><td>接收队列中的字节数</td></tr><tr><td><code>Send-Q</code></td><td>发送队列中的字节数</td></tr><tr><td><code>Local Address</code></td><td>本地IP地址和端口</td></tr><tr><td><code>Foreign Address</code></td><td>远程IP地址和端口</td></tr><tr><td><code>State</code></td><td>连接状态（如<code>LISTEN</code>,<code>ESTABLISHED</code>,<code>TIME_WAIT</code>等）</td></tr><tr><td><code>PID/Program name</code></td><td>进程id或进程名称</td></tr></tbody></table><h4 id="_1-3-案例解析" tabindex="-1"><a class="header-anchor" href="#_1-3-案例解析"><span>1.3 案例解析</span></a></h4><h5 id="_1-3-1-找到当前服务器中连接数使用最多的进程" tabindex="-1"><a class="header-anchor" href="#_1-3-1-找到当前服务器中连接数使用最多的进程"><span>1.3.1 找到当前服务器中连接数使用最多的进程</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tunp</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $7}&#39;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;/&#39;</span> <span class="token parameter variable">-f1</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-nr</span> <span class="token operator">|</span> <span class="token function">head</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>命令解释</p><ul><li><code>netstat -tunp</code>: 显示 <code>TCP</code> 和 <code>UDP</code>连接，以数字形式显示地址和端口，并显示进程ID。</li><li><code>awk &#39;{print $7}&#39;</code>：提取上个命令输出中的第7列，通常是<code>PID/Program name</code>列。</li><li><code>cut -d&#39;/&#39; -f1&#39;</code>：使用<code>/</code>作为分隔符，从中提取第一个片段，即<code>pid</code>。</li><li><code>sort</code>：对进程ID进程排序。</li><li><code>uniq -c</code>：统计每个进程ID出现的次数。</li><li><code>sort -nr</code>：按照连接数进行降序排序。</li><li><code>head</code>：显示连接数最多的前10个进程。</li></ul></li><li><p>结果</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>root@my-host-name admin<span class="token punctuation">]</span><span class="token comment"># netstat -tunp | awk &#39;{print $7}&#39; | cut -d&#39;/&#39; -f1 | sort | uniq -c | sort -nr | head</span></span>
<span class="line">   <span class="token number">2198</span> -</span>
<span class="line">    <span class="token number">145</span> <span class="token number">1452252</span></span>
<span class="line">      <span class="token number">4</span> <span class="token number">2136313</span></span>
<span class="line">      <span class="token number">1</span> Address</span>
<span class="line">      <span class="token number">1</span> <span class="token number">691</span></span>
<span class="line">      <span class="token number">1</span> <span class="token number">2510786</span></span>
<span class="line">      <span class="token number">1</span> <span class="token number">1675446</span></span>
<span class="line">      <span class="token number">1</span> <span class="token number">1003284</span></span>
<span class="line">      <span class="token number">1</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>结果解析 <ul><li>连接数使用第二多的进程id已经出来了。</li><li>但是连接数使用最多的进程id没有打印出来，可以看第2个案例了</li></ul></li></ul><h5 id="_1-3-2-查看当前服务器中连接状态的统计" tabindex="-1"><a class="header-anchor" href="#_1-3-2-查看当前服务器中连接状态的统计"><span>1.3.2 查看当前服务器中连接状态的统计</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tunp</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $6}&#39;</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-nr</span> <span class="token operator">|</span> <span class="token function">head</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>参数解析不再赘述，参考案例1。</li><li>结果</li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>root@my-host-name admin<span class="token punctuation">]</span><span class="token comment"># netstat -tunp | awk &#39;{print $6}&#39; | sort | uniq -c | sort -nr | head</span></span>
<span class="line">   <span class="token number">2323</span> TIME_WAIT</span>
<span class="line">    <span class="token number">145</span> ESTABLISHED</span>
<span class="line">      <span class="token number">1</span> Foreign</span>
<span class="line">      <span class="token number">1</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>结果解析 <ul><li>有<code>2323</code>个连接处于<code>TIME_WAIT</code>状态，这在<code>TCP</code>协议中，是主动发起关闭的一方才会有的状态。</li><li>有<code>145</code>个连接处于<code>ESTABLISHED</code>状态，和案例1中进程号<code>1452252</code>对应的连接数差不多，应该是这个进程建立了这么多连接。确认方法参考案例3。</li><li>接下来我们要找出是哪个进程导致了这么多<code>TIME_WAIT</code>状态产生，参考案例3。</li></ul></li></ul><h5 id="_1-3-3-统计产生time-wait状态连接的本地端口号前3名。" tabindex="-1"><a class="header-anchor" href="#_1-3-3-统计产生time-wait状态连接的本地端口号前3名。"><span>1.3.3 统计产生<code>TIME_WAIT</code>状态连接的本地端口号前3名。</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">netstat</span> <span class="token parameter variable">-tunp</span> <span class="token operator">|</span> <span class="token function">grep</span> TIME_WAIT <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $4}&#39;</span> <span class="token operator">|</span> <span class="token function">cut</span> -d<span class="token string">&#39;:&#39;</span> <span class="token parameter variable">-f2</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token parameter variable">-c</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-nr</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token number">3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>参数解析</p><ul><li><code>sort -nr</code>：降序排序</li><li><code>head -n 3</code>：展示3条数据，结合前面就是展示处于 <code>TIME_WAIT</code>状态最多的3个端口号。</li></ul></li><li><p>结果</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>root@my-host-name admin<span class="token punctuation">]</span><span class="token comment"># netstat -tunp | grep TIME_WAIT | awk &#39;{print $4}&#39; | cut -d&#39;:&#39; -f2 | sort | uniq -c | sort -nr | head -n 3</span></span>
<span class="line">   <span class="token number">2236</span> <span class="token number">8090</span></span>
<span class="line">      <span class="token number">1</span> <span class="token number">60446</span></span>
<span class="line">      <span class="token number">1</span> <span class="token number">59712</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>结果解析 <ul><li>可以看出，是<code>8090</code>端口产生了这么多的<code>TIME_WAIT</code>。</li><li>找出监听<code>8090</code>端口的进程，参考案例4。</li></ul></li></ul><h5 id="_1-3-4-找出端口对应的进程id" tabindex="-1"><a class="header-anchor" href="#_1-3-4-找出端口对应的进程id"><span>1.3.4 找出端口对应的进程id</span></a></h5><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">netstat</span> -tunlp<span class="token operator">|</span><span class="token function">grep</span> <span class="token number">8090</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><p>参数解析</p><ul><li><code>-l</code>：仅显示处于监听状态的<code>socket</code>。如果不加<code>-l</code>参数会打印出和<code>8090</code>端口相关的所有连接，但是我们只想知道是哪个进程在监听<code>8090</code>端口，所以要加上<code>-l</code>参数。</li></ul></li><li><p>结果</p></li></ul><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token punctuation">[</span>root@my-host-name admin<span class="token punctuation">]</span><span class="token comment"># netstat -tunlp|grep 8090</span></span>
<span class="line">tcp6       <span class="token number">0</span>      <span class="token number">0</span> :::8090                 :::*                    LISTEN      <span class="token number">1452252</span>/java</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>结果解析 <ul><li>是一个<code>Java进程</code>，进程ID是<code>1452252</code>，可以通过<code>ps</code>命令找到是哪个具体的进程了。</li></ul></li></ul></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">上次更新时间: </span><!----></div><!----></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blogs/assets/app-CB8GcC1F.js" defer></script>
  </body>
</html>
